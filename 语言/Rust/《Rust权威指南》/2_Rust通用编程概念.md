# 🧱 Rust 第二章：通用编程概念

## 1. 变量与可变性 (Variables & Mutability)

### 🔒 默认不可变

Rust 的变量默认是**不可变 (Immutable)** 的。这体现了 Rust 的核心哲学：**安全**。如果你不显式声明要修改，编译器就认为你不会修改，从而帮你避免并发 bug。

Rust

```
fn main() {
    let x = 5;
    // x = 6; // ❌ 报错：cannot assign twice to immutable variable
    
    let mut y = 5; // 👈 mut 是 mutable 的缩写
    y = 6; // ✅ 通过
}
```

### 👻 变量隐藏 (Shadowing)

这是 Rust 一个非常有特色的功能。你可以重复使用同一个变量名，**新的变量会遮盖（Shadow）旧的变量**。

- **本质**：这不仅仅是修改值，而是**彻底创建了一个新变量**。
- **优势**：
    1. **改变类型**：你可以把一个字符串变成数字，但沿用同一个名字（不用想 `input_str`, `input_num` 这种名字了）。
    2. **保持不可变**：新变量依然默认是不可变的。

Rust

```
fn main() {
    // 1. 改变值
    let x = 5;
    let x = x + 1; // x 变成了 6

    // 2. 改变类型
    let spaces = "   ";       // 类型是 &str
    let spaces = spaces.len(); // 💥 x 变成了 usize 类型，完全合法！
}
```

> **易错点**：如果你用 `mut`，是不能改变类型的！ `let mut x = " "; x = x.len();` ❌ 报错：类型不匹配。

### 🆚 常量 (Constants)

- **关键字**：`const`。
- **特点**：
    - 必须**显式标注类型**。
    - **永远**不可变（没有 `mut` 选项）。
    - 可以在全局作用域声明。
    - **编译时求值**：必须绑定到一个常量表达式，不能是函数调用的结果。

Rust

```
// 全大写，下划线分隔
const MAX_POINTS: u32 = 100_000; 
```

---

## 2. 数据类型 (Data Types)

Rust 是**静态类型**语言，编译器必须在编译时知道所有变量的类型。详见 [[静态类型语言的特点与优缺点]] ^91a308

### 🔢 标量类型 (Scalar Types)

#### 整数 (Integers)

- **分类**：有符号 (`i`) 和 无符号 (`u`)。
- **长度**：`8`, `16`, `32`, `64`, `128`。
- **特殊**：`isize` / `usize`。
    - 长度取决于你的 CPU 架构。64位机上就是 64位，32位机上就是 32位。
    - 主要用于**索引**数组或集合。

**🚨 重点拓展：整数溢出 (Integer Overflow)** 如果你给一个 `u8` 赋值 `256`（最大只能存 255）：

1. **Debug 模式**：Rust 会检查并在运行时 **Panic**（崩溃退出）。
2. **Release 模式**：Rust **不会**检查，而是执行**二进制补码环绕 (Two's Complement Wrapping)**。`256` 会变成 `0`，`257` 会变成 `1`。
    - _注意_：虽然 Release 模式不报错，但这通常是逻辑 Bug。
    - _显式处理_：如果你的逻辑确实需要环绕，请使用标准库方法，如 `wrapping_add`。

#### 浮点数 (Floating-Point)

- `f64`（默认）：双精度，速度快且精度高。
- `f32`：单精度。

#### 字符 (Char)

- Rust 的 `char` 类型大小是 **4 字节**！
- 它代表一个 **Unicode 标量值**。这意味着它可以存储中文、emoji（😻）、韩文等，不仅仅是 ASCII。

### 📦 复合类型 (Compound Types)

#### 元组 (Tuple)

- **特点**：长度固定，**元素类型可以不同**。
- **用法**：常用于函数返回多个值。

Rust

```
let tup: (i32, f64, u8) = (500, 6.4, 1);

// 1. 模式匹配解构 (Destructuring)
let (x, y, z) = tup;

// 2. 点号索引
let five_hundred = tup.0;
```

#### 数组 (Array)

- **特点**：长度固定，**元素类型必须相同**。
- **内存**：数据存放在**栈 (Stack)** 上（除非被 Box 包裹）。
- **安全性**：**越界访问**（Index Out of Bounds）。
    - C 语言：可能访问到非法内存（不安全，甚至导致漏洞）。
    - Rust：**运行时 Panic**。程序直接停止，防止你拿到垃圾数据。

Rust

```
// 类型声明：[类型; 长度]
let a: [i32; 5] = [1, 2, 3, 4, 5];

// 初始化语法：[初始值; 长度]
let a = [3; 5]; // 等同于 [3, 3, 3, 3, 3]
```

---

## 3. 函数 (Functions)

Rust 代码风格：**蛇形命名法 (snake_case)**，所有字母小写，下划线分隔。

### 📝 参数与返回值

- **必须显式声明参数类型**。这是 Rust 设计者的刻意为之，为了让编译器能更好地推断其他地方的类型。
- **返回值**：使用 `->` 声明。

### 💡 重点：语句 (Statements) vs 表达式 (Expressions)

这是 Rust 与许多其他语言（如 C/Java）最大的不同点之一。

- **语句 (Statements)**：执行操作，但**没有返回值**。
    - `let y = 6;` 是一个语句。
    - _陷阱_：`x = y = 6` 在 Rust 中是错误的，因为 `y = 6` 不返回值，`x` 没东西可赋。
- **表达式 (Expressions)**：进行计算并**产生一个值**。
    - `5 + 6` 是表达式。
    - `{ let x = 3; x + 1 }` 是代码块表达式。
- **隐式返回**：
    - 如果函数的最后一行**没有分号**，它就是一个表达式，其值作为函数的返回值。
    - 如果加了分号，它就变成了语句，返回单元类型 `()`。

Rust

```
fn plus_one(x: i32) -> i32 {
    x + 1  // ✅ 表达式，返回 x+1
}

fn plus_one_error(x: i32) -> i32 {
    x + 1; // ❌ 语句，返回 ()，与签名的 -> i32 不匹配！
}
```

---

## 4. 控制流 (Control Flow)

### if 表达式

- **必须是布尔值**：Rust **不会**自动把 `1` 当作 `true`，把 `0` 当作 `false`。必须写 `if number != 0`。
- **它是个表达式**：`if` 结构本身可以返回值，用来给变量赋值。
    
    Rust
    
    ```
    let number = if true { 5 } else { 6 };
    // 注意：if 和 else 分支返回的类型必须一样！
    ```
    

### 循环 (Loops)

1. **`loop`**：无限循环。
    
    - **高级用法**：`loop` 是一个表达式，可以用 `break value` 返回值。
    
    Rust
    
    ```
    let result = loop {
        counter += 1;
        if counter == 10 {
            break counter * 2; // 返回 20
        }
    };
    ```
    
2. **`while`**：条件循环。
3. **`for`**：遍历集合。**这是 Rust 中最常用的循环**，因为它最安全且简洁。

Rust

```
let a = [10, 20, 30];

// 推荐写法：使用迭代器
for element in a.iter() {
    println!("the value is: {}", element);
}

// Range 写法：(1..4) 包含1，不包含4
for number in (1..4).rev() { // rev() 用于反转
    println!("{}!", number);
}
```

---

## 🎓 总结

这一章我们搭建了 Rust 编程的脚手架：

- **变量**：默认不可变，想要修改加 `mut`，想要变身用 `shadowing`。
- **类型**：整数溢出有策略，数组越界会 Panic，Char 能存 Emoji。
- **函数**：分清语句（带分号，没值）和表达式（没分号，有值）是写出 Rust 风格代码的关键。
- **控制流**：`if` 是表达式，`for` 循环最常用。

下一步，我们将进入 Rust 最核心、最独特、也是最“劝退”的章节：**所有权 (Ownership)**。做好准备！🛡️